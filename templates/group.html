{% extends "base.html" %} {% block content %}
<a href="/groups" class="link">← Back to Groups</a>

<!-- GROUP HEADER -->
<div style="display:flex; justify-content:space-between; align-items:flex-start; gap:14px; flex-wrap:wrap; margin-bottom:20px;">

  <!-- LEFT: TITLE -->
  <div>
    <h2 style="margin:0;">
      {{ group.name }}
      <span class="badge badge-muted" style="margin-left:10px;">
        Created by {{ creator.name }}
      </span>
    </h2>
  </div>

  <!-- RIGHT: ACTIONS -->
  <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">

    <a href="/expenses/new?group_id={{ group.id }}" class="btn primary">
      + Add Expense
    </a>

    <a href="/settlements/new?group_id={{ group.id }}" class="btn success">
      ✔ Settle Up
    </a>

    {% if can_manage %}
    <details style="position:relative;">
      <summary class="btn secondary" style="cursor:pointer; list-style:none;">
        More ▾
      </summary>

      <div style="
        position:absolute;
        right:0;
        top:110%;
        background:#fff;
        border:1px solid #eee;
        border-radius:12px;
        padding:10px;
        min-width:190px;
        box-shadow:0 10px 30px rgba(0,0,0,0.08);
        z-index:10;
      ">
        <a href="/groups/{{ group.id }}/members" class="link" style="display:block; padding:8px 10px;">
          + Add Members
        </a>

        <a href="/groups/{{ group.id }}/rename" class="link" style="display:block; padding:8px 10px;">
          Rename Group
        </a>

        <form
          method="POST"
          action="/groups/{{ group.id }}/delete"
          onsubmit="return confirm('Are you sure you want to delete this group?');"
          style="margin:0;"
        >
          <button type="submit" class="link" style="display:block; width:100%; text-align:left; padding:8px 10px; color:#b00020; background:none; border:none;">
            Delete Group
          </button>
        </form>
      </div>
    </details>
    {% endif %}

  </div>
</div>


<!-- MEMBERS -->
<div class="card">
  <h3>Members</h3>
  <ul class="member-list numbered">
    {% for m in members %}
    <li class="member-item">
      <strong class="member-name">{{ m.name }}</strong>
    </li>
    {% endfor %}
  </ul>
</div>

<!-- BALANCES -->
<div class="card">
  <h3>Balances</h3>
  <div class="balance-grid">
    {% for b in balances %}
    <div
      class="balance {% if b.balance == 0 %}zero{% elif b.balance > 0 %}positive{% else %}negative{% endif %}"
    >
      <strong>{{ b.name }}</strong>

      <p>₹{{ "%.2f"|format(b.balance|abs) }}</p>

      <small>
        {% if b.balance > 0 %}gets back{% elif b.balance < 0 %}owes{% else
        %}settled{% endif %}
      </small>
    </div>
    {% endfor %}
  </div>

  <br />
  <small>*Balances may change if past expenses are edited.</small>
</div>

<!-- ADD EXPENSE + SETTLEMENT BUTTONS -->

<!-- HISTORY -->
<div class="two-col">
  <div class="card">
    <h3>Settlement History</h3>
    {% for s in settlements %}
    <div class="row">
      <span class="settlement-amount">₹{{ s.amount }}</span>
      {{ s.payer_name }} → {{ s.receiver_name }}
      <small>{{ s.created_at.strftime("%d %b %Y") }}</small>
    </div>
    {% else %}
    <p class="muted">No settlements yet.</p>
    {% endfor %}
  </div>

  <div class="card">
    <h3>Recent Expenses</h3>
    {% for e in expenses %}
    <div
      class="row"
      style="display: flex; justify-content: space-between; align-items: center"
    >
      <div style="flex: 1">
        <div>
          <span class="recent-expense-amount">₹{{ e.amount }}</span>
          - {{ e.description or "No description" }}
        </div>
        <small style="color: #6f6f6f">
          Paid by {{ e.payer_name }} {% if e.last_edited_by_name %} | Edited by
          {{ e.last_edited_by_name }} {{ e.last_edited_at.strftime('%d %b %Y')
          if e.last_edited_at }} {% else %} | Created {{
          e.created_at.strftime('%d %b %Y') if e.created_at }} {% endif %}
        </small>
      </div>

      {% if current_user and (e.created_by == current_user.id or can_manage) %}
      <div style="display: flex; gap: 4px">
        <a
          href="/expenses/{{ e.id }}/edit"
          class="btn secondary"
          style="padding: 4px 8px; font-size: 12px; text-decoration: none"
          >Edit</a
        >
        <form
          method="POST"
          action="/expenses/{{ e.id }}/delete"
          style="margin: 0"
          onsubmit="return confirm('Are you sure you want to delete this expense?');"
        >
          <button
            type="submit"
            class="btn danger"
            style="padding: 4px 8px; font-size: 12px"
          >
            Delete
          </button>
        </form>
      </div>
      {% endif %}
    </div>
    {% else %}
    <p class="muted">No expenses yet.</p>
    {% endfor %}
  </div>
</div>

{% endblock %}
