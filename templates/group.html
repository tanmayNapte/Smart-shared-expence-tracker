{% extends "base.html" %}
{% block content %}

<a href="/dashboard" class="link">← Back to Groups</a>

<!-- GROUP HEADER -->
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
  <h2 class="group-title">
  {{ group.name }}
  <span class="badge badge-muted">
  <span>Created by {{ creator.name }}</span>
    </span>
  {% if is_creator %}
    <span class="badge badge-creator">Creator</span>
  {% endif %}

  {% if is_admin %}
    <span class="badge badge-admin">Admin</span>
  {% endif %}
</h2>

  

  {% if can_manage %}
  <div style="display:flex;gap:8px;align-items:center">

    <a href="/groups/{{ group.id }}/members" class="btn primary">
      + Add Members
    </a>

    <a href="/groups/{{ group.id }}/rename" class="btn secondary">
      Rename Group
    </a>

    <form method="POST" action="/groups/{{ group.id }}/delete"
          onsubmit="return confirm('Are you sure you want to delete this group?');"
          style="margin:0">
      <button type="submit" class="btn danger">x Delete Group</button>
    </form>

  </div>
  {% endif %}
</div>

<!-- MEMBERS -->
<div class="card">
  <h3>Members</h3>
  <ul class="member-list numbered">
    {% for m in members %}
    <li class="member-item">
      <strong class="member-name">{{ m.name }}</strong>
    </li>
    {% endfor %}
  </ul>
</div>

<!-- BALANCES -->
<div class="card">
  <h3>Balances</h3>
  <div class="balance-grid">
    {% for b in balances %}
    <div class="balance {% if b.balance == 0 %}zero{% elif b.balance > 0 %}positive{% else %}negative{% endif %}">
      <strong>{{ b.name }}</strong>
      <p>₹{{ b.balance | abs }}</p>
      <small>
        {% if b.balance > 0 %}gets back{% elif b.balance < 0 %}owes{% else %}settled{% endif %}
      </small>
    </div>
    {% endfor %}
  </div>
  <br>
  <small>*Balances may change if past expenses are edited.</small>
</div>

{% if suggestions %}
<div class="card">
  <h3>Suggested Settlements</h3>
  {% for s in suggestions %}
  <div class="suggested-settlement">
    <div class="settlement-row">
      <span class="label">From</span>
      <span class="value">{{ s.from_name }}</span>
    </div>
    <div class="settlement-row">
      <span class="label">To</span>
      <span class="value">{{ s.to_name }}</span>
    </div>
    <div class="settlement-row">
      <span class="label">Amount</span>
      <span class="amount">₹{{ s.amount }}</span>
    </div>
    <div class="settlement-note">
      Recommended settlement to balance accounts
    </div>
  </div>
  {% endfor %}
</div>
{% endif %}

<!-- ADD EXPENSE + SETTLEMENT -->
<div class="two-col">

  <!-- ADD EXPENSE -->
  <div class="card">
    <h3>Add Expense</h3>
    <form method="post" action="/expenses/add">
      <input type="hidden" name="group_id" value="{{ group.id }}">
      <input name="amount" placeholder="Amount" required>
      <input name="description" placeholder="Description">

      <select name="paid_by" required>
        <option value="">Paid by</option>
        {% for m in members %}
        <option value="{{ m.id }}">{{ m.name }}</option>
        {% endfor %}
      </select>

      <button class="btn primary">+ Add Expense</button>
    </form>
  </div>

  <!-- RECORD SETTLEMENT (UX-IMPROVED) -->
  <div class="card">
    <h3>Record Settlement</h3>

    <form method="post" action="/settlements/add">
      <input type="hidden" name="group_id" value="{{ group.id }}">

      <label>Payer</label>
      <select name="payer_id" required>
        <option value="">Select payer</option>
        {% for m in members %}
        <option value="{{ m.id }}" {% if current_user and m.id == current_user.id %}selected{% endif %}>
          {{ m.name }}{% if current_user and m.id == current_user.id %} (You){% endif %}
        </option>
        {% endfor %}
      </select>

      <label>Receiver</label>
      <select name="receiver_id" required>
        <option value="">Select receiver</option>
        {% for m in members %}
        <option value="{{ m.id }}">
          {{ m.name }}{% if current_user and m.id == current_user.id %} (You){% endif %}
        </option>
        {% endfor %}
      </select>

      <input name="amount" placeholder="Amount" required>

      <button class="btn success">✔ Record Settlement</button>

      <p style="font-size:12px;color:#6f6f6f;margin-top:8px;">
        Settlement must involve you (payer or receiver).  
        You can only settle up to the amount owed.
      </p>
    </form>
  </div>
</div>

<!-- HISTORY -->
<div class="two-col">
  <div class="card">
    <h3>Settlement History</h3>
    {% for s in settlements %}
    <div class="row">
      <span class="settlement-amount">₹{{ s.amount }}</span>
      {{ s.payer_name }} → {{ s.receiver_name }}
      <small>{{ s.created_at.strftime("%d %b %Y") }}</small>
    </div>
    {% else %}
    <p class="muted">No settlements yet.</p>
    {% endfor %}
  </div>

  <div class="card">
    <h3>Recent Expenses</h3>
    {% for e in expenses %}
    <div class="row" style="display:flex;justify-content:space-between;align-items:center;">
      <div style="flex:1;">
        <div>
          <span class="recent-expense-amount">₹{{ e.amount }}</span>
          - {{ e.description or "No description" }}
        </div>
        <small style="color:#6f6f6f;">
          Paid by {{ e.payer_name }}
          {% if e.last_edited_by_name %}
            | Edited by {{ e.last_edited_by_name }} {{ e.last_edited_at.strftime('%d %b %Y') if e.last_edited_at }}
          {% else %}
            | Created {{ e.created_at.strftime('%d %b %Y') if e.created_at }}
          {% endif %}
        </small>
      </div>

      {% if current_user and (e.created_by == current_user.id or can_manage) %}
      <div style="display:flex;gap:4px;">
        <a href="/expenses/{{ e.id }}/edit" class="btn secondary"
           style="padding:4px 8px;font-size:12px;text-decoration:none;">Edit</a>
        <form method="POST" action="/expenses/{{ e.id }}/delete"
              style="margin:0"
              onsubmit="return confirm('Are you sure you want to delete this expense?');">
          <button type="submit" class="btn danger"
                  style="padding:4px 8px;font-size:12px;">Delete</button>
        </form>
      </div>
      {% endif %}
    </div>
    {% else %}
    <p class="muted">No expenses yet.</p>
    {% endfor %}
  </div>
</div>

{% endblock %}
