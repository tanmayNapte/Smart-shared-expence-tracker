{% extends "base.html" %}
{% block title %}Record Settlement{% endblock %}
{% block main_class %}full-width{% endblock %}

{% block content %}
<div class="dashboard-wrapper">

  <aside class="ledger-sidebar">
    <div class="sidebar-brand">
      <!-- <a href="/dashboard" style="text-decoration:none; color:inherit;">
        <h3>Ledger</h3>
      </a> -->
    </div>

    <nav class="sidebar-nav">
      <a href="/dashboard" class="nav-item"><span class="icon">âŠž</span> Dashboard</a>
      <a href="/groups" class="nav-item"><span class="icon">ðŸ‘¥</span> Groups</a>
      <a href="/activity" class="nav-item active">
        <span class="icon">âš¡</span> Activity
      </a>
      <a href="/profile" class="nav-item"><span class="icon">ðŸ‘¤</span> Profile</a>
    </nav>
  </aside>

  <main class="dashboard-main">
    <div class="card" style="max-width:600px;margin:2rem auto;">
      <h3>Record Settlement</h3>
      <p class="muted-text">Record a payment between group members</p>

      <form method="post" action="/settlements/add">


        <label>Group</label>
        <select name="group_id" id="group_select" required>
          <option value="">Select a group</option>
          {% for g in groups %}
          <option value="{{ g.id }}" {% if selected_group_id==g.id %}selected{% endif %}>
            {{ g.name }}
          </option>
          {% endfor %}
        </select>

        <label>Payer (Who paid?)</label>
        <select name="payer_id" id="payer_select" required disabled>
          <option value="">Select a group first</option>
        </select>

        <label>Receiver (Who got paid?)</label>
        <select name="receiver_id" id="receiver_select" required disabled>
          <option value="">Select a group first</option>
        </select>

        <label>Amount</label>
        <input name="amount" type="number" step="0.01" min="0.01" placeholder="0.00" required>

        <div style="margin-top:2rem;">
          <button class="btn success" style="width:100%;">Record Settlement</button>
        </div>

        <p style="font-size:12px;color:#6f6f6f;margin-top:8px;text-align:center;">
          Settlement must involve you (payer or receiver).
        </p>
      </form>
    </div>
  </main>
</div>

<script>
  // Safely get user ID
  const CURRENT_USER_ID = JSON.parse('{{ current_user.id if current_user else "null" }}');

  document.addEventListener('DOMContentLoaded', () => {
    const groupSelect = document.getElementById('group_select');
    const payerSelect = document.getElementById('payer_select');
    const receiverSelect = document.getElementById('receiver_select');

    if (!groupSelect || !payerSelect || !receiverSelect) {
      console.error("Critical elements missing");
      return;
    }

    async function loadMembers(groupId) {
      payerSelect.innerHTML = '<option value="">Loading...</option>';
      receiverSelect.innerHTML = '<option value="">Loading...</option>';
      payerSelect.disabled = true;
      receiverSelect.disabled = true;

      if (!groupId) {
        resetSelects();
        return;
      }

      try {
        console.log("Fetching members for group:", groupId);
        const response = await fetch(`/api/groups/${groupId}/members`);

        if (!response.ok) {
          console.error("API Error:", response.status, response.statusText);
          throw new Error("Failed to load members: " + response.statusText);
        }

        const members = await response.json();
        console.log("Members loaded:", members);

        populateSelect(payerSelect, members, "Select payer");
        populateSelect(receiverSelect, members, "Select receiver");

        payerSelect.disabled = false;
        receiverSelect.disabled = false;

      } catch (error) {
        console.error('Error in loadMembers:', error);
        alert("Error loading group members. Please try refreshing.");
        payerSelect.innerHTML = '<option value="">Error loading members</option>';
        receiverSelect.innerHTML = '<option value="">Error loading members</option>';
      }
    }

    function populateSelect(select, members, placeholder) {
      select.innerHTML = `<option value="">${placeholder}</option>`;
      members.forEach(member => {
        const option = document.createElement('option');
        option.value = member.id;

        let label = member.name;
        if (CURRENT_USER_ID && member.id == CURRENT_USER_ID) {
          label += " (You)";
        }

        option.textContent = label;
        select.appendChild(option);
      });
    }

    function resetSelects() {
      payerSelect.innerHTML = '<option value="">Select a group first</option>';
      receiverSelect.innerHTML = '<option value="">Select a group first</option>';
      payerSelect.disabled = true;
      receiverSelect.disabled = true;
    }

    // Event Listeners
    groupSelect.addEventListener('change', () => {
      loadMembers(groupSelect.value);
    });

    payerSelect.addEventListener('change', () => {
      if (payerSelect.value && payerSelect.value === receiverSelect.value) {
        alert("Payer and receiver cannot be the same");
        payerSelect.value = "";
      }
    });

    receiverSelect.addEventListener('change', () => {
      if (receiverSelect.value && receiverSelect.value === payerSelect.value) {
        alert("Payer and receiver cannot be the same");
        receiverSelect.value = "";
      }
    });

    // Initial load
    if (groupSelect.value) {
      loadMembers(groupSelect.value);
    }
  });
</script>
{% endblock %}